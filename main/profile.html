<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="/profile.css">
  <link rel="icon" href="/img/logo.png">
</head>
<body id="top">
  <header class="site-header" role="banner">
    <div class="container">
      <div class="brand"><a href="index.html"><img src="http://localhost:5000/images/static/img/logo.png" alt="Logo"></a></div>
      <nav class="site-nav" role="navigation" aria-label="–û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é">
        <ul class="nav-menu">
          <li><a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a></li>
          <li><a href="catalog.html">–ö–∞—Ç–∞–ª–æ–≥</a></li>
          <li><a href="about.html">–û –Ω–∞—Å</a></li>
          <li><a href="contacts.html">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a></li>
        </ul>
      </nav>
      <div class="header-actions">
          <a href="cart.html" class="header-cart" aria-label="–ö–æ—Ä–∑–∏–Ω–∞" title="–ö–æ—Ä–∑–∏–Ω–∞">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 6h15l-1.5 9h-11L6 6z" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="10" cy="20" r="1.5" fill="#333"/><circle cx="18" cy="20" r="1.5" fill="#333"/></svg>
          <span class="cart-count badge bg-danger" style="display:none">0</span>
          </a>
          <a href="login.html" class="header-login btn btn-outline-primary btn-sm">–í—Ö–æ–¥</a>
          <a href="register.html" class="btn btn-primary btn-sm ms-1">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
          </a>
      </div>
    </div>
  </header>

  <div class="profile-page">
      <h1>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>

      <div class="profile-layout">
        <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
        <aside class="profile-menu">
          <nav>
            <button class="menu-item active" onclick="switchTab('profile')">–ü—Ä–æ—Ñ–∏–ª—å</button>
            <button class="menu-item" onclick="switchTab('orders')">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</button>
            <button class="menu-item logout" onclick="logoutUser()">–í—ã—Ö–æ–¥</button>
          </nav>
        </aside>

        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
        <main class="profile-content">
          <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
          <section id="profile-tab" class="profile-tab active">
            <div class="profile-header">
              <div class="profile-avatar-section">
                <div id="profile-avatar">üë§</div>
                <div class="avatar-actions">
                  <button onclick="document.getElementById('avatar-input').click()" type="button">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                  <button id="avatar-remove" type="button">–£–¥–∞–ª–∏—Ç—å</button>
                  <input type="file" id="avatar-input" accept="image/*">
                </div>
              </div>
              <div class="profile-info">
                <h2 id="profile-display-name">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
                <div class="profile-details">
                  <div class="profile-field">
                    <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input id="profile-username" type="text" placeholder="–ù–µ —É–∫–∞–∑–∞–Ω–æ">
                  </div>
                  <div class="profile-field">
                    <label>Email</label>
                    <input id="profile-email" type="email" placeholder="–ù–µ —É–∫–∞–∑–∞–Ω–æ" readonly>
                  </div>
                  <div class="profile-field">
                    <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input id="profile-phone" type="tel" placeholder="–ù–µ —É–∫–∞–∑–∞–Ω–æ">
                  </div>
                  <div class="profile-field">
                    <label>–ì–æ—Ä–æ–¥</label>
                    <input id="profile-city" type="text" placeholder="–ù–µ —É–∫–∞–∑–∞–Ω–æ">
                  </div>
                </div>
              </div>
            </div>
            <div class="profile-actions">
              <button id="profile-save" class="btn btn-primary" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button id="profile-cancel" class="btn" type="button">–û—Ç–º–µ–Ω–∞</button>
            </div>
          </section>

          <!-- –ú–æ–∏ –∑–∞–∫–∞–∑—ã -->
          <section id="orders-tab" class="profile-tab" style="display:none;">
            <h2>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
            <div id="orders-list" class="orders-list"></div>
            <div id="no-orders" style="text-align:center; padding:80px 200px; color:#777; min-height:200px; display:flex; flex-direction:column; justify-content:center; align-items:center;">
              <p style="font-size:16px; margin-bottom:20px;">–£ –≤–∞—Å –µ—â—ë –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>
              <a href="catalog.html" class="btn" style="background:var(--accent); color:#fff; padding:12px 30px; border-radius:4px; text-decoration:none; display:inline-block;">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥</a>
            </div>
          </section>

          <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ -->
          <div id="order-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center;">
            <div style="background:#fff; border-radius:8px; padding:30px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 id="modal-order-title" style="margin:0;">–ó–∞–∫–∞–∑ #123</h3>
                <button onclick="closeOrderModal()" style="border:none; background:none; font-size:24px; cursor:pointer; color:#777;">‚úï</button>
              </div>
              <div style="border-bottom:1px solid #e7e7e7; padding-bottom:20px; margin-bottom:20px;">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; font-size:14px;">
                  <div><span style="color:#777; font-size:12px; text-transform:uppercase;">–î–∞—Ç–∞</span><div id="modal-order-date" style="font-weight:600; margin-top:5px;">15.12.2025</div></div>
                  <div><span style="color:#777; font-size:12px; text-transform:uppercase;">–°—Ç–∞—Ç—É—Å</span><div id="modal-order-status" style="font-weight:600; margin-top:5px;">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</div></div>
                </div>
              </div>
              <div style="margin-bottom:20px;">
                <h4 style="font-size:14px; color:#777; text-transform:uppercase; margin-bottom:15px;">–¢–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑–µ</h4>
                <div id="modal-order-items" style="display:flex; flex-direction:column; gap:12px;">
                  <!-- –¢–æ–≤–∞—Ä—ã –¥–æ–±–∞–≤—è—Ç—Å—è —Å—é–¥–∞ -->
                </div>
              </div>
              <div style="border-top:1px solid #e7e7e7; padding-top:20px; text-align:right;">
                <div style="font-size:12px; color:#777; text-transform:uppercase; margin-bottom:5px;">–ò—Ç–æ–≥–æ</div>
                <div id="modal-order-total" style="font-size:24px; font-weight:700; color:var(--accent);">0 ‚ÇΩ</div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>

  <footer class="site-footer" role="contentinfo">
    <div class="container">
      <div class="footer-inner">
        <h3><a href="privacy-policy.html">¬© –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã</a></h3>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/scripts.js"></script>
  <script>
    // Ensure switchTab exists early to avoid ReferenceError from inline onclick
    window.switchTab = function(tab, el){
      try {
        document.querySelectorAll('.profile-tab').forEach(t=> t.style.display = 'none');
        const target = document.getElementById(tab + '-tab');
        if (target) target.style.display = 'block';
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        if (el && el.classList) el.classList.add('active');
      } catch(e){
        // If DOM not ready, store pending and let the main initializer handle it
        window._pendingSwitch = { tab, el };
      }
    };
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', async ()=>{
      const token = localStorage.getItem('token');
      if (!token) { window.location.href = '/login.html'; return; }
      
      try{
        // Load user profile
        const res = await fetch('http://localhost:5000/api/auth/me', {
          headers: {'Authorization': 'Bearer ' + token}
        });
        if (res.ok){
          const data = await res.json();
          document.getElementById('profile-username').value = data.username || '';
          document.getElementById('profile-email').value = data.email || '';
          document.getElementById('profile-phone').value = data.phone || '';
          document.getElementById('profile-city').value = data.city || '';
          document.getElementById('profile-display-name').textContent = (data.username || '–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç');
        }

        // Load orders
        const or = await fetch('http://localhost:5000/api/orders', { 
          headers: {'Authorization': 'Bearer ' + token} 
        });
        if (or.ok){
          const orders = await or.json();
          const list = document.getElementById('orders-list');
          const noOrders = document.getElementById('no-orders');
          
          if (!orders || !orders.length) {
            list.style.display = 'none';
            noOrders.style.display = 'block';
          } else {
            list.style.display = 'flex';
            noOrders.style.display = 'none';
            list.innerHTML = '';
            orders.forEach(o=>{
              const orderDate = new Date(o.created_at).toLocaleDateString('ru-RU');
              const statusClass = o.status === 'completed' ? 'completed' : o.status === 'cancelled' ? 'cancelled' : 'pending';
              const statusText = {
                'completed': '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ',
                'pending': '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ',
                'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–æ'
              }[o.status] || '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ';
              
              const div = document.createElement('div');
              div.className = 'order-card';
              div.style.cursor = 'pointer';
              div.onclick = () => openOrderModal(o.id, token);
              div.innerHTML = `
                <div class="order-header">
                  <div>
                    <div class="order-number-label">–ó–∞–∫–∞–∑</div>
                    <div class="order-number">#${o.id}</div>
                  </div>
                  <div class="order-meta">
                    <span>${orderDate}</span>
                    <span>${o.items_count || 0} —Ç–æ–≤–∞—Ä(–æ–≤)</span>
                  </div>
                  <span class="order-status ${statusClass}">${statusText}</span>
                </div>
                <div class="order-body">
                  <div class="order-item">
                    <div class="order-item-info">
                      <div class="order-item-name">–¢–æ–≤–∞—Ä—ã –∑–∞–∫–∞–∑–∞</div>
                      <div class="order-item-price">${o.items_count || 0} —Ç–æ–≤–∞—Ä–æ–≤</div>
                    </div>
                  </div>
                  <div class="order-total">
                    <div class="order-total-label">–°—É–º–º–∞</div>
                    <div class="order-total-amount">${o.total_amount || 0} ‚ÇΩ</div>
                  </div>
                </div>`;
              list.appendChild(div);
            });
          }
        }
      }catch(e){console.error(e)}
      
      // Tab switching (enhanced)
      window.switchTab = function(tab, el) {
        document.querySelectorAll('.profile-tab').forEach(t => t.style.display = 'none');
        const target = document.getElementById(tab + '-tab');
        if (target) target.style.display = 'block';
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        // prefer explicit element param
        if (el && el.classList) el.classList.add('active');
      };
      // If a switch was requested before DOM ready, apply it now
      if (window._pendingSwitch && window._pendingSwitch.tab) {
        try { window.switchTab(window._pendingSwitch.tab, window._pendingSwitch.el); } catch(e){}
        window._pendingSwitch = null;
      }
      
      // Logout
      window.logoutUser = function() {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) return;
        localStorage.removeItem('token');
        localStorage.removeItem('user_id');
        window.location.href = '/';
      };

      // Avatar handling
      const avatarContainer = document.getElementById('profile-avatar');
      const avatarInput = document.getElementById('avatar-input');
      const avatarRemove = document.getElementById('avatar-remove');
      
      function refreshAvatar(){
        const data = localStorage.getItem('user_avatar');
        if (data){
          avatarContainer.innerHTML = `<img src="${data}" style="width:96px;height:96px;border-radius:50%;object-fit:cover;">`;
        } else {
          avatarContainer.textContent = 'üë§';
        }
        if (window.renderHeaderAvatar) window.renderHeaderAvatar();
      }
      refreshAvatar();

      avatarInput.addEventListener('change', (ev)=>{
        const f = ev.target.files && ev.target.files[0];
        if (!f) return;
        if (!f.type.startsWith('image/')) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'); return; }
        if (f.size > 2 * 1024 * 1024) { alert('–§–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–µ–Ω—å—à–µ 2MB'); return; }
        const r = new FileReader();
        r.onload = ()=>{
          try { localStorage.setItem('user_avatar', r.result); refreshAvatar(); alert('–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω'); } catch (e){ alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞'); }
        };
        r.readAsDataURL(f);
      });

      avatarRemove.addEventListener('click', ()=>{
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –∞–≤–∞—Ç–∞—Ä?')) return;
        localStorage.removeItem('user_avatar'); refreshAvatar();
      });

      // Profile save button
      document.getElementById('profile-save').addEventListener('click', async ()=>{
        const data = {
          username: document.getElementById('profile-username').value,
          phone: document.getElementById('profile-phone').value,
          city: document.getElementById('profile-city').value
        };
        try {
          const res = await fetch('http://localhost:5000/api/auth/update', {
            method: 'PUT',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
          if (res.ok) {
            alert('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω');
          } else {
            const err = await res.json();
            alert(err.error || '–û—à–∏–±–∫–∞');
          }
        } catch (e) {
          console.error(e);
          alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        }
      });

      document.getElementById('profile-cancel').addEventListener('click', ()=>{
        window.location.reload();
      });
    });

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å—é –∑–∞–∫–∞–∑–∞
    window.openOrderModal = async (orderId, token) => {
      try {
        const res = await fetch(`http://localhost:5000/api/orders/${orderId}`, {
          headers: {'Authorization': 'Bearer ' + token}
        });
        if (res.ok) {
          const order = await res.json();
          document.getElementById('modal-order-title').textContent = `–ó–∞–∫–∞–∑ #${order.id}`;
          
          const orderDate = new Date(order.created_at).toLocaleDateString('ru-RU');
          document.getElementById('modal-order-date').textContent = orderDate;
          
          const statusText = {
            'completed': '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ',
            'pending': '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ',
            'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–æ'
          }[order.status] || '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ';
          document.getElementById('modal-order-status').textContent = statusText;
          
          document.getElementById('modal-order-total').textContent = `${order.total_amount || 0} ‚ÇΩ`;
          
          const itemsContainer = document.getElementById('modal-order-items');
          itemsContainer.innerHTML = '';
          
          if (order.items && order.items.length) {
            order.items.forEach(item => {
              const itemDiv = document.createElement('div');
              itemDiv.style.cssText = 'padding:12px; background:#f5f5f5; border-radius:4px; display:grid; grid-template-columns:60px 1fr auto; gap:12px; align-items:center;';
              
              itemDiv.innerHTML = `
                <div>
                  <div style="font-weight:600; font-size:14px; margin-bottom:4px; width:30vw">${item.product_name}</div>
                  <div style="font-size:12px; color:#777;">x${item.quantity} —à—Ç.</div>
                </div>
                <div style="text-align:right;">
                  <div style="font-weight:700; color:var(--accent);">${(item.product_price * item.quantity).toFixed(2)} ‚ÇΩ</div>
                  <div style="font-size:12px; color:#777;">${item.product_price} ‚ÇΩ/—à—Ç</div>
                </div>
              `;
              itemsContainer.appendChild(itemDiv);
            });
          }
          
          document.getElementById('order-modal').style.display = 'flex';
        }
      } catch (e) {
        console.error(e);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–∞');
      }
    };

    window.closeOrderModal = () => {
      document.getElementById('order-modal').style.display = 'none';
    };

    document.getElementById('order-modal').addEventListener('click', (e) => {
      if (e.target.id === 'order-modal') closeOrderModal();
    });
  </script>
</body>
</html>
